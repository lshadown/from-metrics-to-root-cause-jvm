services:
    # =========================
    # Metrics: Prometheus
    # =========================
    prometheus:
      image: prom/prometheus:latest
      container_name: prometheus
      ports:
        - "9090:9090"
      volumes:
        - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      command:
        - --config.file=/etc/prometheus/prometheus.yml
      depends_on:
        - api-service
        - external-service

    # =========================
    # Dashboards: Grafana
    # =========================
    grafana:
      image: grafana/grafana:latest
      container_name: grafana
      ports:
        - "3000:3000"
      environment:
        - GF_SECURITY_ADMIN_USER=admin
        - GF_SECURITY_ADMIN_PASSWORD=admin
      depends_on:
        - prometheus

    # =========================
    # Logs: Elasticsearch
    # =========================
    elasticsearch:
      image: docker.elastic.co/elasticsearch/elasticsearch:8.14.3
      container_name: elasticsearch
      environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
      ports:
        - "9200:9200"
      volumes:
        - esdata:/usr/share/elasticsearch/data

    # =========================
    # Logs: Kibana
    # =========================
    kibana:
      image: docker.elastic.co/kibana/kibana:8.14.3
      container_name: kibana
      environment:
        - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        - XPACK_SECURITY_ENABLED=false
      ports:
        - "5601:5601"
      depends_on:
        - elasticsearch

    # =========================
    # Logs: Logstash (ingest)
    # =========================
    logstash:
      image: docker.elastic.co/logstash/logstash:8.14.3
      container_name: logstash
      environment:
        - xpack.monitoring.enabled=false
        - LS_JAVA_OPTS=-Xms128m -Xmx128m
      ports:
        - "5044:5044"   # Beats input
        - "9600:9600"   # Logstash monitoring API
      volumes:
        - ./observability/logstash/pipeline:/usr/share/logstash/pipeline:ro
      depends_on:
        - elasticsearch

    # =========================
    # Logs: Filebeat (ships docker logs -> Logstash)
    # =========================
    filebeat:
      image: docker.elastic.co/beats/filebeat:8.14.3
      container_name: filebeat
      user: root
      volumes:
        - ./observability/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
        - /var/lib/docker/containers:/var/lib/docker/containers:ro
        - /var/run/docker.sock:/var/run/docker.sock:ro
      depends_on:
        - logstash

    # =========================
    # Tracing: Zipkin
    # =========================
    zipkin:
      image: openzipkin/zipkin:latest
      container_name: zipkin
      ports:
        - "9411:9411"
    external-service:
      build: ./external-service
      ports:
        - "8081:8081"
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:8081/enrichment?userId=1"]
        interval: 5s
        timeout: 3s
        retries: 5
        start_period: 15s

    api-service:
      build: ./api-service
      ports:
        - "8080:8080"
      environment:
        - EXTERNAL_BASE_URL=http://external-service:8081
      depends_on:
        external-service:
          condition: service_healthy
volumes:
  esdata: